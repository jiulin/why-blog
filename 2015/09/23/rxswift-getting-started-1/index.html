<!doctype html>
<html class="theme-next   use-motion ">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"/>




  
    <link href='//fonts.lug.ustc.edu.cn/css?family=Lato:300,400,700,400italic&subset=latin,latin-ext' rel='stylesheet' type='text/css'>
  



<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=0.4.5.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="RxSwift," />





  <link rel="alternate" href="/atom.xml" title="Why's Blog" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=0.4.5.2" />






<meta name="description" content="万水千山总是情，留坑在此行不行=。=">
<meta property="og:type" content="article">
<meta property="og:title" content="RxSwift 入坑手册 Part1 - 示例实战">
<meta property="og:url" content="http://blog.callmewhy.com/2015/09/23/rxswift-getting-started-1/index.html">
<meta property="og:site_name" content="Why's Blog">
<meta property="og:description" content="万水千山总是情，留坑在此行不行=。=">
<meta property="og:image" content="http://ww2.sinaimg.cn/large/61d238c7gw1ewdy2ss0l9j21kw0xdtlw.jpg">
<meta property="og:updated_time" content="2015-10-01T07:55:11.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="RxSwift 入坑手册 Part1 - 示例实战">
<meta name="twitter:description" content="万水千山总是情，留坑在此行不行=。=">



<script type="text/javascript" id="hexo.configuration">
  var CONFIG = {
    scheme: '',
    sidebar: 'post',
    motion: true
  };
</script>

  <title> RxSwift 入坑手册 Part1 - 示例实战 | Why's Blog </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  <!--[if lte IE 8]>
  <div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;margin:0 auto;'>
    <a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode">
      <img src="http://7u2nvr.com1.z0.glb.clouddn.com/picouterie.jpg" border="0" height="42" width="820"
           alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today or use other browser ,like chrome firefox safari."
           style='margin-left:auto;margin-right:auto;display: block;'/>
    </a>
  </div>
<![endif]-->
  



  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?d4761ad5a08d996a2d7b90d5b1a79395";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <div class="container one-column page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Why's Blog</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">从明天起，做一个幸福的人。面朝汪海，春暖花开。</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu menu-left">
      
        
        
          <li class="menu-item menu-item-home">
            <a href="/" rel="section">
              
                <i class="menu-item-icon fa fa-home fa-fw"></i> <br />
              
              首页
            </a>
          </li>
        
      
        
        
      
        
        
      
        
        
          <li class="menu-item menu-item-archives">
            <a href="/archives" rel="section">
              
                <i class="menu-item-icon fa fa-archive fa-fw"></i> <br />
              
              归档
            </a>
          </li>
        
      
        
        
          <li class="menu-item menu-item-about">
            <a href="/about" rel="section">
              
                <i class="menu-item-icon fa fa-user fa-fw"></i> <br />
              
              关于
            </a>
          </li>
        
      

      
      
        <li class="menu-item menu-item-search">
          <a href="#" class="st-search-show-outputs">
            
              <i class="menu-item-icon fa fa-search icon-next-search"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  

<script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
    (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
    e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

  _st('install', 'J2QQHPVLVpZZmkmZhBSf','2.0.0');
</script>



    </div>
  
</nav>
 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div id="content" class="content">
          

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                RxSwift 入坑手册 Part1 - 示例实战
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2015-09-23T14:45:59+08:00" content="2015-09-23">
              2015-09-23
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/开发笔记/" itemprop="url" rel="index">
                    <span itemprop="name">开发笔记</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/09/23/rxswift-getting-started-1/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/09/23/rxswift-getting-started-1/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        <span itemprop="articleBody"><h2 id="Intro">Intro</h2><p>这部分主要是学习 <a href="https://github.com/ReactiveX/RxSwift/" target="_blank" rel="external">RxSwift</a> 项目中的示例项目，了解 <code>RxSwift</code> 在实际 iOS 开发中的正确打开方式。</p>
<h2 id="Demo1:_GitHub_Signup">Demo1: <a href="https://github.com/ReactiveX/RxSwift/tree/master/RxExample/RxExample/Examples/GitHubSignup" target="_blank" rel="external">GitHub Signup</a></h2><p>第一个示例是 GitHub 注册账号的例子。输入用户名、密码、重复密码，然后提交注册。</p>
<h3 id="username">username</h3><p>在注册流程中，用户名校验是一个很常见的功能。我们一般需要对用户名做如下检查和流程：</p>
<ul>
<li>是否不为空</li>
<li>是否不包含非法字符</li>
<li>是否没有被注册过</li>
<li>以上均通过，联网注册</li>
<li>是否成功连接上服务器</li>
<li>服务器是否正确处理并返回结果</li>
</ul>
<p>要通过 RxSwift 实现以上流程，可以划分成如下几步。</p>
<h4 id="rx_text">rx_text</h4><p>如果想监听文字输入，我们最好能有一个 <code>Observable</code> 的对象不断地给我们发送新的输入值。<code>rx_text</code> 是 RxSwift 针对 Cocoa 库做的各种封装中的一个，可以简单看下它的定义：</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">UITextField</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">    Reactive wrapper for `text` property.</span><br><span class="line">    */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">var</span> rx_text: <span class="type">ControlProperty</span>&lt;<span class="type">String</span>&gt; &#123;</span><br><span class="line">        <span class="keyword">return</span> rx_value(getter: &#123; [<span class="keyword">weak</span> <span class="keyword">self</span>] <span class="keyword">in</span></span><br><span class="line">            <span class="keyword">self</span>?.text ?? <span class="string">""</span></span><br><span class="line">        &#125;, setter: &#123; [<span class="keyword">weak</span> <span class="keyword">self</span>] value <span class="keyword">in</span></span><br><span class="line">            <span class="keyword">self</span>?.text = value</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>返回的 <code>ControlProperty</code> 遵循 <code>ControlPropertyType</code> 协议：</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">protocol</span> <span class="title">ControlPropertyType</span> : <span class="title">ObservableType</span>, <span class="title">ObserverType</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span><br><span class="line">    - returns: `ControlProperty` interface</span><br><span class="line">    */</span></span><br><span class="line">    <span class="func"><span class="keyword">func</span> <span class="title">asControlProperty</span><span class="params">()</span></span> -&gt; <span class="type">ControlProperty</span>&lt;<span class="type">E</span>&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到，它既是一个可被订阅者 (<code>ObservableType</code>)，又是一个订阅者 (<code>ObserverType</code>)，也就是说它是一个 <a href="http://blog.callmewhy.com/2015/09/21/rxswift-getting-started-0/#Subjects"><code>Subject</code></a> 对象。由于它是 <code>Observable</code> 的，所以我们可以通过 <code>map</code> 把它转换成想要的输出，例如下面这段代码会实现『每输入一个字就在控制台输出当前内容』的功能（记得 RAC 的系列教程似乎也是这个节奏）：</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line">    <span class="preprocessor">@IBOutlet</span> <span class="keyword">weak</span> <span class="keyword">var</span> usernameOutlet: <span class="type">UITextField</span>!</span><br><span class="line">    <span class="keyword">override</span> <span class="func"><span class="keyword">func</span> <span class="title">viewDidLoad</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.viewDidLoad()</span><br><span class="line">        <span class="keyword">let</span> username = usernameOutlet.rx_text</span><br><span class="line">        username.subscribeNext &#123;</span><br><span class="line">            <span class="built_in">print</span>($<span class="number">0</span>)</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="validate">validate</h4><p>接下来就是验证用户名的阶段了。首先需要一个方法，将用户名转换成一串流。为什么是流？为了统一口径。先看代码：</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typealias</span> <span class="type">ValidationResult</span> = (valid: <span class="type">Bool</span>?, message: <span class="type">String</span>?)</span><br><span class="line"></span><br><span class="line"><span class="func"><span class="keyword">func</span> <span class="title">validateUsername</span><span class="params">(username: String)</span></span> -&gt; <span class="type">Observable</span>&lt;<span class="type">ValidationResult</span>&gt; &#123;</span><br><span class="line">    <span class="comment">// 如果用户名为空</span></span><br><span class="line">    <span class="keyword">if</span> username.characters.<span class="built_in">count</span> == <span class="number">0</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> just((<span class="literal">false</span>, <span class="literal">nil</span>))</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 如果用户名中出现非法字符</span></span><br><span class="line">    <span class="keyword">if</span> username.rangeOfCharacterFromSet(<span class="type">NSCharacterSet</span>.alphanumericCharacterSet().invertedSet) != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> just((<span class="literal">false</span>, <span class="string">"Username can only contain numbers or digits"</span>))</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 加载中的值</span></span><br><span class="line">    <span class="keyword">let</span> loadingValue = (valid: <span class="literal">nil</span> <span class="keyword">as</span> <span class="type">Bool</span>?, message: <span class="string">"Checking availabilty ..."</span> <span class="keyword">as</span> <span class="type">String</span>?)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 校验用户名</span></span><br><span class="line">    <span class="keyword">return</span> <span class="type">API</span>.usernameAvailable(username)</span><br><span class="line">        .<span class="built_in">map</span> &#123; available <span class="keyword">in</span></span><br><span class="line">            <span class="keyword">if</span> available &#123;</span><br><span class="line">                <span class="keyword">return</span> (<span class="literal">true</span>, <span class="string">"Username available"</span>)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> (<span class="literal">false</span>, <span class="string">"Username already taken"</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        .startWith(loadingValue)    <span class="comment">// 在加载结果之前插入 加载中 这个状态的事件值</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>梳理一下：</p>
<ul>
<li>如果用户名为空，返回 <code>(false, nil)</code> 完事儿</li>
<li>如果用户名有非法字符，返回 <code>(false, &quot;Username can only contain numbers or digits&quot;)</code> 完事儿</li>
<li>如果本地检查没问题，发给服务器检查，先发送一个事件 <code>loadingValue</code> 表示正在加载，加载成功再发送结果事件</li>
</ul>
<p>这就是我所理解的『统一口径』。虽然本地检查分分钟就能给你个结果，但是如果统一都用『流』来表述，外部处理起来会简单得多。不用管具体的结果是什么，只需要知道是一个 <code>Observable</code> 对象，并且随之而来的是一串事件，就足够了。这一串事件，有可能只有一个，提示用户名不能为空；也有可能有很多，先提示正在加载，然后再提示注册成功。在外部来看，这就是一个事件流。</p>
<p>试想一下如果用 UIKit 的那一套来写这个流程，肯定要监听个 <code>valueChanged</code> 事件然后在委托方法里先判断 A ，如果不符合就刷新 UI ；再判断 B ，不符合就刷新 UI ；最后发请求给服务器，刷新 UI 提示等待，然后加载完了再刷新个 UI 。。。</p>
<h4 id="switch">switch</h4><p>把上面的验证代码用到项目中大概就是这样：</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> usernameValidation = username</span><br><span class="line">    .<span class="built_in">map</span> &#123; username <span class="keyword">in</span></span><br><span class="line">        <span class="keyword">return</span> validationService.validateUsername(username)</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>如果把每次的文字改动事件用 v 来表示，那整个事件序列应该是这样的：</p>
<pre><code><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="comment">V</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="comment">V</span><span class="literal">-</span><span class="literal">-</span><span class="comment">V</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="comment">V</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="comment">V</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span>
</code></pre><p>而用了 <code>validateUsername</code> 之后，它会把以前的值转换成一个新的序列，就成了这样：</p>
<pre><code>----|<span class="string">------</span>|<span class="string">--</span>|<span class="string">---</span>|<span class="string">---</span>|<span class="string">----
    </span>|<span class="string">      </span>|<span class="string">  </span>|<span class="string">   </span>|<span class="string">   </span>|
    V      V  V   V   V
    |<span class="string">      </span>|<span class="string">  </span>|<span class="string">   </span>|<span class="string">   </span>|
    |<span class="string">      V  </span>|<span class="string">   V   </span>|
    |<span class="string">      </span>|<span class="string">  </span>|<span class="string">   </span>|<span class="string">   </span>|
</code></pre><p>瞬间变成了二维世界了，我们可以用 <a href="http://blog.callmewhy.com/2015/09/21/rxswift-getting-started-0/#switch"><code>switch</code></a> 来『降维』（这名词是我自己起的，如果有更好的称呼欢迎随时打脸(￣ε(#￣)☆╰╮(￣▽￣///))。这里我们选用 <code>switchLastest</code> ：</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> usernameValidation = username</span><br><span class="line">    .<span class="built_in">map</span> &#123; username <span class="keyword">in</span></span><br><span class="line">        <span class="keyword">return</span> validationService.validateUsername(username)</span><br><span class="line">    &#125;</span><br><span class="line">    .switchLatest()</span><br></pre></td></tr></table></figure>
<p>不妨看一下 ObservableType 的定义：</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">ObservableType</span> <span class="title">where</span> <span class="title">E</span> : <span class="title">ObservableType</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="func"><span class="keyword">func</span> <span class="title">switchLatest</span><span class="params">()</span></span> -&gt; <span class="type">Observable</span>&lt;<span class="type">E</span>.<span class="type">E</span>&gt; &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="type">Switch</span>(sources: <span class="keyword">self</span>.asObservable())</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个扩展是针对『自己是 <code>ObservableType</code> 且自己监听的事件也是 <code>ObservableType</code> 』这一类对象的。通过 <code>switchLatest</code> 方法我们可以将前面的二维结构梳理成一维结构，每次自动切换到新的序列的最新事件上。</p>
<pre><code>----|<span class="string">------</span>|<span class="string">--</span>|<span class="string">---</span>|<span class="string">---</span>|<span class="string">----
    V      </span>|<span class="string">  </span>|<span class="string">   </span>|<span class="string">   </span>|
    |<span class="string">------</span>|<span class="string">  </span>|<span class="string">   </span>|<span class="string">   </span>|
    |<span class="string">      V  </span>|<span class="string">   </span>|<span class="string">   </span>|
    |<span class="string">      V  </span>|<span class="string">   </span>|<span class="string">   </span>|
    |<span class="string">      </span>|<span class="string">--</span>|<span class="string">   </span>|<span class="string">   </span>|
    |<span class="string">      </span>|<span class="string">  V   </span>|<span class="string">   </span>|
    |<span class="string">      </span>|<span class="string">  </span>|<span class="string">---</span>|<span class="string">   </span>|
    |<span class="string">      </span>|<span class="string">  </span>|<span class="string">   V   </span>|
    |<span class="string">      </span>|<span class="string">  </span>|<span class="string">   V   </span>|
    |<span class="string">      </span>|<span class="string">  </span>|<span class="string">   </span>|<span class="string">---</span>|
    |<span class="string">      </span>|<span class="string">  </span>|<span class="string">   </span>|<span class="string">   V</span>
</code></pre><p>执行结果如下：</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> usernameValidation = username</span><br><span class="line">        .<span class="built_in">map</span> &#123; username <span class="keyword">in</span></span><br><span class="line">            <span class="keyword">return</span> validationService.validateUsername(username)</span><br><span class="line">        &#125;</span><br><span class="line">        .switchLatest()</span><br><span class="line">        .subscribe &#123;</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"Event: - <span class="subst">\($<span class="number">0</span>)</span>"</span>)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">----- <span class="type">Output</span> -----</span><br><span class="line"><span class="comment">// 输入 12!</span></span><br><span class="line"><span class="type">Event</span>: - <span class="type">Next</span>((<span class="type">Optional</span>(<span class="literal">false</span>), <span class="type">Optional</span>(<span class="string">"Username can only contain numbers or digits"</span>)))</span><br><span class="line"><span class="comment">// 输出 abc</span></span><br><span class="line"><span class="type">Event</span>: - <span class="type">Next</span>((<span class="literal">nil</span>, <span class="type">Optional</span>(<span class="string">"Checking availabilty ..."</span>)))</span><br><span class="line"><span class="type">Event</span>: - <span class="type">Next</span>((<span class="type">Optional</span>(<span class="literal">false</span>), <span class="type">Optional</span>(<span class="string">"Username already taken"</span>)))</span><br></pre></td></tr></table></figure>
<h4 id="replay">replay</h4><p>我们在 <code>map</code> 里调用了 <code>validateUsername</code> 方法，这会导致如果有多个订阅者的话，会重复调用多次。</p>
<p>例如这个例子：</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> sequenceOfElements = sequenceOf(<span class="number">0</span>).<span class="built_in">map</span> &#123; r -&gt; <span class="type">Int</span> <span class="keyword">in</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"MAP"</span>)    <span class="comment">// twice</span></span><br><span class="line">    <span class="keyword">return</span> r * <span class="number">2</span></span><br><span class="line">&#125;    </span><br><span class="line"><span class="keyword">let</span> subscription = sequenceOfElements</span><br><span class="line">    .subscribe &#123; event <span class="keyword">in</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"1 - <span class="subst">\(event)</span>"</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> subscription2 = sequenceOfElements</span><br><span class="line">    .subscribe &#123; event <span class="keyword">in</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"2 - <span class="subst">\(event)</span>"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">--- <span class="built_in">map</span> example ---</span><br><span class="line"><span class="type">MAP</span></span><br><span class="line"><span class="number">1</span> - <span class="type">Next</span>(<span class="number">0</span>)</span><br><span class="line"><span class="number">1</span> - <span class="type">Completed</span></span><br><span class="line"><span class="type">MAP</span></span><br><span class="line"><span class="number">2</span> - <span class="type">Next</span>(<span class="number">0</span>)</span><br><span class="line"><span class="number">2</span> - <span class="type">Completed</span></span><br></pre></td></tr></table></figure>
<p>我一开始很疑惑，明明订阅的是 <code>map</code> 之后的队列，但是为什么 <code>subscribe</code> 每次都会重新 <code>map</code> 一次呢？</p>
<p>经提醒之后又去仔细翻阅了入门文档 <a href="https://github.com/ReactiveX/RxSwift/blob/master/Documentation/GettingStarted.md" target="_blank" rel="external">Getting Started</a> ，看到了下面这段话：</p>
<blockquote>
<p>Every subscriber upon subscription usually generates it’s own separate sequence of elements. Operators are stateless by default. There is vastly more stateless operators then stateful ones.</p>
</blockquote>
<p>这么一想就说得通了，一切都是为了 <code>stateless</code> 。如果 <code>subscribe</code> 的是 <code>map</code> 后的结果，那就意味着需要多存储一个状态，而状态的增加往往意味着复杂度的指数级增长。</p>
<p>为了解决这个多次订阅会多次执行的问题，我们需要 <code>shareReplay</code> ，看下这个示例：</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> sequenceOfInts = <span class="type">PublishSubject</span>&lt;<span class="type">Int</span>&gt;()</span><br><span class="line"><span class="keyword">let</span> a = sequenceOfInts.<span class="built_in">map</span>&#123; i -&gt; <span class="type">Int</span> <span class="keyword">in</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"MAP---<span class="subst">\(i)</span>"</span>)</span><br><span class="line">    <span class="keyword">return</span> i * <span class="number">2</span></span><br><span class="line">&#125;.shareReplay(<span class="number">3</span>)</span><br><span class="line"><span class="keyword">let</span> b = a.subscribeNext &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"--1--<span class="subst">\($<span class="number">0</span>)</span>"</span>)</span><br><span class="line">&#125;</span><br><span class="line">sequenceOfInts.on(.<span class="type">Next</span>(<span class="number">1</span>))</span><br><span class="line">sequenceOfInts.on(.<span class="type">Next</span>(<span class="number">2</span>))</span><br><span class="line"><span class="keyword">let</span> <span class="built_in">c</span> = a.subscribeNext &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"--2--<span class="subst">\($<span class="number">0</span>)</span>"</span>)</span><br><span class="line">&#125;</span><br><span class="line">sequenceOfInts.on(.<span class="type">Next</span>(<span class="number">3</span>))</span><br><span class="line">sequenceOfInts.on(.<span class="type">Next</span>(<span class="number">4</span>))</span><br><span class="line"><span class="keyword">let</span> d = a.subscribeNext &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"--3--<span class="subst">\($<span class="number">0</span>)</span>"</span>)</span><br><span class="line">&#125;</span><br><span class="line">sequenceOfInts.on(.<span class="type">Completed</span>)</span><br><span class="line"></span><br><span class="line">--- shareReplay example ---</span><br><span class="line"><span class="type">MAP</span>---<span class="number">1</span></span><br><span class="line">--<span class="number">1</span>--<span class="number">2</span></span><br><span class="line"><span class="type">MAP</span>---<span class="number">2</span></span><br><span class="line">--<span class="number">1</span>--<span class="number">4</span></span><br><span class="line">--<span class="number">2</span>--<span class="number">2</span></span><br><span class="line">--<span class="number">2</span>--<span class="number">4</span></span><br><span class="line"><span class="type">MAP</span>---<span class="number">3</span></span><br><span class="line">--<span class="number">1</span>--<span class="number">6</span></span><br><span class="line">--<span class="number">2</span>--<span class="number">6</span></span><br><span class="line"><span class="type">MAP</span>---<span class="number">4</span></span><br><span class="line">--<span class="number">1</span>--<span class="number">8</span></span><br><span class="line">--<span class="number">2</span>--<span class="number">8</span></span><br><span class="line">--<span class="number">3</span>--<span class="number">4</span></span><br><span class="line">--<span class="number">3</span>--<span class="number">6</span></span><br><span class="line">--<span class="number">3</span>--<span class="number">8</span></span><br></pre></td></tr></table></figure>
<p><code>shareReplay</code> 会返回一个新的事件序列，它监听底层序列的事件，并且通知自己的订阅者们。不过和传统的订阅不同的是，它是通过『重播』的方式通知自己的订阅者。就像是过目不忘的看书，但是每次都只记得最后几行的内容，在有人询问的时候就背诵出来。从上面的例子可以看到，通过 <code>shareReplay</code> 订阅的 <code>map</code> 并不会调用多次。所以我们也可以把它应用到 <code>validateUsername</code> 上：</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> usernameValidation = username</span><br><span class="line">    .<span class="built_in">map</span> &#123; username <span class="keyword">in</span></span><br><span class="line">        <span class="keyword">return</span> validationService.validateUsername(username)</span><br><span class="line">    &#125;</span><br><span class="line">    .switchLatest()</span><br><span class="line">    .shareReplay(<span class="number">1</span>)</span><br></pre></td></tr></table></figure>
<p>这样就不会出现『多次订阅导致重复地检查用户名是否可用』的情况了。</p>
<h4 id="usernameAvailable">usernameAvailable</h4><p>前面梳理了基本的用户名校验流程，接下来看下联网检测这部分是如何实现的。</p>
<p>联网检测用户名是否可用主要是访问用户名对应的 github 地址然后查看是否是 404 ，如果不是那就说明已经被注册了。核心代码如下：</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="func"><span class="keyword">func</span> <span class="title">usernameAvailable</span><span class="params">(username: String)</span></span> -&gt; <span class="type">Observable</span>&lt;<span class="type">Bool</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="type">URL</span> = <span class="type">NSURL</span>(string: <span class="string">"https://github.com/<span class="subst">\(URLEscape(username)</span>)"</span>)!</span><br><span class="line">    <span class="keyword">let</span> request = <span class="type">NSURLRequest</span>(<span class="type">URL</span>: <span class="type">URL</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>.<span class="type">URLSession</span>.rx_response(request)</span><br><span class="line">        .<span class="built_in">map</span> &#123; (maybeData, maybeResponse) <span class="keyword">in</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">let</span> response = maybeResponse <span class="keyword">as</span>? <span class="type">NSHTTPURLResponse</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> response.statusCode == <span class="number">404</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        .observeOn(<span class="keyword">self</span>.dataScheduler)</span><br><span class="line">        .catchErrorJustReturn(<span class="literal">false</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>和前面的 <code>rx_value</code> 相似， <code>rx_response</code> 是针对 <code>NSURLSession</code> 的扩展。通过 <code>observeOn</code> 将监听事件绑定在了 <code>dataScheduler</code> 上。最后 <code>catchErrorJustReturn(false)</code> 表明如果出现异常就返回个 <code>false</code> 。</p>
<p><a href="https://github.com/ReactiveX/RxSwift/blob/master/Documentation/Schedulers.md" target="_blank" rel="external"><code>Scheduler</code></a> 是一种 Rx 里的任务运行机制，类似的 <code>gcd</code> 里的 <code>dispatch queue</code> 。可以通过 <code>observeOn</code> 切换 <code>scheduler</code> ：</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line">sequence1</span><br><span class="line">    .observeOn(backgroundScheduler)</span><br><span class="line">    .<span class="built_in">map</span> &#123; n <span class="keyword">in</span></span><br><span class="line">      <span class="built_in">println</span>(<span class="string">"This is performed on background scheduler"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    .observeOn(<span class="type">MainScheduler</span>.sharedInstance)</span><br><span class="line">    .<span class="built_in">map</span> &#123; n <span class="keyword">in</span></span><br><span class="line">      <span class="built_in">println</span>(<span class="string">"This is performed on main scheduler"</span>)</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="password">password</h3><p>密码的检测相比较用户名而言就简单很多，核心代码如下：</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="func"><span class="keyword">func</span> <span class="title">validatePassword</span><span class="params">(password: String)</span></span> -&gt; <span class="type">ValidationResult</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> numberOfCharacters = password.characters.<span class="built_in">count</span></span><br><span class="line">    <span class="keyword">if</span> numberOfCharacters == <span class="number">0</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> (<span class="literal">false</span>, <span class="literal">nil</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> numberOfCharacters &lt; minPasswordCount &#123;</span><br><span class="line">        <span class="keyword">return</span> (<span class="literal">false</span>, <span class="string">"Password must be at least <span class="subst">\(minPasswordCount)</span> characters"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (<span class="literal">true</span>, <span class="string">"Password acceptable"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意这里返回了 <code>ValidationResult</code> ，因为所有校验都是本地完成的。</p>
<p>接下来就是重复密码的校验，这部分比较有意思，通过 <a href="http://blog.callmewhy.com/2015/09/21/rxswift-getting-started-0/#combineLatest"><code>combineLatest</code></a> 将两个序列合并起来：</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> repeatPasswordValidation = combineLatest(password, repeatPassword) &#123; (password, repeatedPassword) <span class="keyword">in</span></span><br><span class="line">        validationService.validateRepeatedPassword(password, repeatedPassword: repeatedPassword)</span><br><span class="line">    &#125;</span><br><span class="line">    .shareReplay(<span class="number">1</span>)</span><br></pre></td></tr></table></figure>
<p>然后 <code>validateRepeatedPassword</code> 方法如下：</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="func"><span class="keyword">func</span> <span class="title">validateRepeatedPassword</span><span class="params">(password: String, repeatedPassword: String)</span></span> -&gt; <span class="type">ValidationResult</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> repeatedPassword.characters.<span class="built_in">count</span> == <span class="number">0</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> (<span class="literal">false</span>, <span class="literal">nil</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> repeatedPassword == password &#123;</span><br><span class="line">        <span class="keyword">return</span> (<span class="literal">true</span>, <span class="string">"Password repeated"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> (<span class="literal">false</span>, <span class="string">"Password different"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这几个例子基本都是把事件序列进行组装然后『外包』给其他对象去处理。</p>
<h3 id="bindValidationResultToUI">bindValidationResultToUI</h3><p>检查也检查好了，接下来的就是更新 UI 了，用户名非法、两次密码不一致，这些都需要通过刷新 UI 告知用户。也就是说，需要把前面定义的『事件流』和『用户界面』绑定起来。看下这个绑定的方法：</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="func"><span class="keyword">func</span> <span class="title">bindValidationResultToUI</span><span class="params">(source: Observable&lt;ValidationResult&gt;,</span><br><span class="line">    validationErrorLabel: UILabel)</span></span> &#123;</span><br><span class="line">    source</span><br><span class="line">        .subscribeNext &#123; v <span class="keyword">in</span></span><br><span class="line">            <span class="keyword">let</span> validationColor: <span class="type">UIColor</span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">let</span> valid = v.valid &#123;</span><br><span class="line">                validationColor = valid ? okColor : errorColor</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">               validationColor = <span class="type">UIColor</span>.grayColor()</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            validationErrorLabel.textColor = validationColor</span><br><span class="line">            validationErrorLabel.text = v.message ?? <span class="string">""</span></span><br><span class="line">        &#125;</span><br><span class="line">        .addDisposableTo(disposeBag)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在这里出现了 <code>addDisposableTo(disposeBag)</code> ，在此需要解释一下 <a href="https://github.com/ReactiveX/RxSwift/blob/master/Documentation/GettingStarted.md#disposing" target="_blank" rel="external"><code>disposing</code></a>  的相关概念。</p>
<p>一个事件流的终结除了前面了解的各种事件之外，还有一种方法，就是 <code>dispose</code> ，释放掉所有的资源。比如这个例子：</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> subscription = interval(<span class="number">0.3</span>, scheduler)</span><br><span class="line">    .subscribe &#123; (e: <span class="type">Event</span>&lt;<span class="type">Int64</span>&gt;) <span class="keyword">in</span></span><br><span class="line">        <span class="built_in">println</span>(e)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="type">NSThread</span>.sleepForTimeInterval(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">subscription.dispose()</span><br><span class="line"></span><br><span class="line">----- <span class="type">Dispose</span> <span class="type">Sample</span> -----</span><br><span class="line"><span class="number">0</span></span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="number">3</span></span><br><span class="line"><span class="number">4</span></span><br><span class="line"><span class="number">5</span></span><br></pre></td></tr></table></figure>
<p>然而 <code>dispose</code> 方法是不推荐使用的，推荐使用更好的解决方案， <code>DisposeBag</code> 就是一个。<code>addDisposableTo(disposeBag)</code> 有点像是 ARC ，先把分配的资源统一丢到袋子里 (有点像是 <code>autoreleasepool</code>) ，然后当 <code>disposeBag</code> 销毁的时候就一起销毁这些资源。在代码里可以看到，只要有 <code>subscribe</code> 的基本在最后都会兜上一个 <code>.addDisposableTo(disposeBag)</code> 用来处理资源自动销毁的问题。</p>
<h3 id="signupEnabled">signupEnabled</h3><p>检查完毕之后，如果所有条件都符合，那就需要把 <code>Signup</code> 按钮高亮，高亮的逻辑是把多个数据流合并在了一起：</p>
 <figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> signupEnabled = combineLatest(</span><br><span class="line">     usernameValidation,</span><br><span class="line">     passwordValidation,</span><br><span class="line">     repeatPasswordValidation,</span><br><span class="line">     signingProcess</span><br><span class="line"> ) &#123; un, p, pr, signingState <span class="keyword">in</span></span><br><span class="line">     <span class="keyword">return</span> (un.valid ?? <span class="literal">false</span>) &amp;&amp; (p.valid ?? <span class="literal">false</span>) &amp;&amp; (pr.valid ?? <span class="literal">false</span>) &amp;&amp; signingState != <span class="type">SignupState</span>.<span class="type">SigningUp</span></span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>在基本的流都构建完毕的情况下，各种需求更多的是对流的组合拼装。比如这里就再次用到了 <code>usernameValidation</code> 这个流，还好前面有 <a href="http://blog.callmewhy.com/2015/09/23/rxswift-getting-started-1/#replay"><code>shareReplay</code></a> 罩着，我们想复用多少次都没问题。</p>
<h3 id="signingProcess">signingProcess</h3><p>在点击注册按钮之后，就是具体的注册流程了，注册流程的代码是这样的：</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> signingProcess = combineLatest(username, password) &#123; ($<span class="number">0</span>, $<span class="number">1</span>) &#125;</span><br><span class="line">    .sampleLatest(signupSampler)</span><br><span class="line">    .<span class="built_in">map</span> &#123; (username, password) <span class="keyword">in</span></span><br><span class="line">        <span class="keyword">return</span> <span class="type">API</span>.signup(username, password: password)</span><br><span class="line">    &#125;</span><br><span class="line">    .switchLatest()</span><br><span class="line">    .startWith(<span class="type">SignupState</span>.<span class="type">InitialState</span>)</span><br><span class="line">    .shareReplay(<span class="number">1</span>)</span><br></pre></td></tr></table></figure>
<p>这里有个 <code>sampleLatest</code> ，在了解它之前先要了解什么是 <code>sample</code> 。</p>
<h4 id="sample">sample</h4><p><code>sample</code> 就是一次『采样』，当收到采样事件的时候，就会从事件队列中取出一个事件作为『样本』，并发送到事件流里。如果下一次又要采样了，就会从两次采样之间的事件队列中选择最后一个事件，如果两次采集之间没有新的事件就不会进行任何操作。</p>
<p>可以看下这个例子帮助理解：</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> s = <span class="type">PublishSubject</span>&lt;<span class="type">Int</span>&gt;()</span><br><span class="line"><span class="keyword">let</span> o = <span class="type">PublishSubject</span>&lt;<span class="type">String</span>&gt;()</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> subscription = s</span><br><span class="line">    .sample(o)</span><br><span class="line">    .subscribe &#123; event <span class="keyword">in</span></span><br><span class="line">        <span class="built_in">print</span>(event)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">s.on(.<span class="type">Next</span>(<span class="number">1</span>))</span><br><span class="line">o.on(.<span class="type">Next</span>(<span class="string">"A"</span>))</span><br><span class="line">s.on(.<span class="type">Next</span>(<span class="number">2</span>))</span><br><span class="line">s.on(.<span class="type">Next</span>(<span class="number">3</span>))</span><br><span class="line">o.on(.<span class="type">Next</span>(<span class="string">"B"</span>))</span><br><span class="line">o.on(.<span class="type">Next</span>(<span class="string">"C"</span>))</span><br><span class="line"></span><br><span class="line">--- sample example ---</span><br><span class="line"><span class="type">Next</span>(<span class="number">1</span>)</span><br><span class="line"><span class="type">Next</span>(<span class="number">3</span>)</span><br></pre></td></tr></table></figure>
<p><code>sampleLatest</code> 就是，即使两次采样期间没有新的事件也没关系，取整个队列的最后一个事件作为输出。还是上面那个例子：</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> s = <span class="type">PublishSubject</span>&lt;<span class="type">Int</span>&gt;()</span><br><span class="line"><span class="keyword">let</span> o = <span class="type">PublishSubject</span>&lt;<span class="type">String</span>&gt;()</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> subscription = s</span><br><span class="line">    .sampleLatest(o)</span><br><span class="line">    .subscribe &#123; event <span class="keyword">in</span></span><br><span class="line">        <span class="built_in">print</span>(event)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">s.on(.<span class="type">Next</span>(<span class="number">1</span>))</span><br><span class="line">o.on(.<span class="type">Next</span>(<span class="string">"1"</span>))</span><br><span class="line">s.on(.<span class="type">Next</span>(<span class="number">2</span>))</span><br><span class="line">s.on(.<span class="type">Next</span>(<span class="number">3</span>))</span><br><span class="line">o.on(.<span class="type">Next</span>(<span class="string">"2"</span>))</span><br><span class="line">o.on(.<span class="type">Next</span>(<span class="string">"3"</span>))</span><br><span class="line"></span><br><span class="line">--- sample example ---</span><br><span class="line"><span class="type">Next</span>(<span class="number">1</span>)</span><br><span class="line"><span class="type">Next</span>(<span class="number">3</span>)</span><br><span class="line"><span class="type">Next</span>(<span class="number">3</span>)</span><br></pre></td></tr></table></figure>
<p>所以上面的注册流程代码也就可以理解了：</p>
<ul>
<li>先把 username 和 password 绑起来</li>
<li>将注册按钮的点击事件作为一个触发点，每次点击都会获取最新的账号密码走下面的流程</li>
<li>调用 <code>API.signup</code> 进行注册</li>
<li>将 <code>map</code> 之后的二维队列拍平，切换到最新的队列上</li>
<li>将状态置为初始状态</li>
<li>通过 <code>shareReplay</code> 避免重复订阅导致的反复执行的问题</li>
</ul>
<h4 id="signup">signup</h4><p>项目里的注册功能只是一个 <code>mock</code> 而已，并没有真的访问 API ：</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="func"><span class="keyword">func</span> <span class="title">signup</span><span class="params">(username: String, password: String)</span></span> -&gt; <span class="type">Observable</span>&lt;<span class="type">SignupState</span>&gt; &#123;</span><br><span class="line">    <span class="comment">// this is also just a mock</span></span><br><span class="line">    <span class="keyword">let</span> signupResult = <span class="type">SignupState</span>.<span class="type">SignedUp</span>(signedUp: arc4random() % <span class="number">5</span> == <span class="number">0</span> ? <span class="literal">false</span> : <span class="literal">true</span>)</span><br><span class="line">    <span class="keyword">return</span> [just(signupResult), never()]</span><br><span class="line">        .concat()</span><br><span class="line">        .throttle(<span class="number">2</span>, <span class="type">MainScheduler</span>.sharedInstance)</span><br><span class="line">        .startWith(<span class="type">SignupState</span>.<span class="type">SigningUp</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在这里可以看到 <code>never()</code> 的正确打开方式：用于无限等待。  <code>concat</code> 将上面两个序列首尾拼接起来，然后 <code>throttle</code> 等价于 <a href="http://rxmarbles.com/#debounce" target="_blank" rel="external"><code>debounce</code></a> ：如果两个事件的时间间隔小于某个特定值，就会忽视掉前面一个。通过 <code>never</code> + <code>throttle</code> 伪造了一种等待加载2秒然后返回注册结果的错觉。</p>
<h4 id="disposeBag">disposeBag</h4><p>定义了事件流之后，我们就可以通过 <code>subscribeNext</code> 来刷新 UI 了：</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line">signingProcess</span><br><span class="line">    .subscribeNext &#123; [<span class="keyword">unowned</span> <span class="keyword">self</span>] signingResult <span class="keyword">in</span></span><br><span class="line">        <span class="keyword">switch</span> signingResult &#123;</span><br><span class="line">        <span class="keyword">case</span> .<span class="type">SigningUp</span>:</span><br><span class="line">            <span class="keyword">self</span>.signingUpOulet.hidden = <span class="literal">false</span></span><br><span class="line">        <span class="keyword">case</span> .<span class="type">SignedUp</span>(<span class="keyword">let</span> signed):</span><br><span class="line">            <span class="keyword">self</span>.signingUpOulet.hidden = <span class="literal">true</span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">let</span> alertView: <span class="type">UIAlertView</span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> signed &#123;</span><br><span class="line">                alertView = <span class="type">UIAlertView</span>(title: <span class="string">"GitHub"</span>, message: <span class="string">"Mock signed up to GitHub"</span>, delegate: <span class="literal">nil</span>, cancelButtonTitle: <span class="string">"OK"</span>)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                alertView = <span class="type">UIAlertView</span>(title: <span class="string">"GitHub"</span>, message: <span class="string">"Mock signed up failed"</span>, delegate: <span class="literal">nil</span>, cancelButtonTitle: <span class="string">"OK"</span>)</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            alertView.show()</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">self</span>.signingUpOulet.hidden = <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    .addDisposableTo(disposeBag)</span><br></pre></td></tr></table></figure>
<p>注意，每一次 <code>subscribe</code> 都要及时回收资源，在示例代码中是都通过 <code>addDisposableTo(disposeBag)</code> 统一处理了。在 <code>disposeBag</code> 重新赋值的时候就会自动清理资源。</p>
<p>项目中一共有三个地方调用了 <code>disposeBag = DisposeBag()</code> ：</p>
<ul>
<li>定义变量的时候：</li>
</ul>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> disposeBag = <span class="type">DisposeBag</span>()</span><br></pre></td></tr></table></figure>
<ul>
<li><code>viewDidLoad</code> 里：</li>
</ul>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="func"><span class="keyword">func</span> <span class="title">viewDidLoad</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">super</span>.viewDidLoad()</span><br><span class="line">    <span class="keyword">self</span>.disposeBag = <span class="type">DisposeBag</span>()</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>willMoveToParentViewController</code> 里：</li>
</ul>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="comment">// This is one of the reasons why it's a good idea for disposal to be detached from allocations.</span></span><br><span class="line"><span class="comment">// If resources weren't disposed before view controller is being deallocated, signup alert view</span></span><br><span class="line"><span class="comment">// could be presented on top of wrong screen or crash your app if it was being presented while</span></span><br><span class="line"><span class="comment">// navigation stack is popping.</span></span><br><span class="line"><span class="comment">// This will work well with UINavigationController, but has an assumption that view controller will</span></span><br><span class="line"><span class="comment">// never be readded as a child view controller.</span></span><br><span class="line"><span class="comment">// It it was readded UI wouldn't be bound anymore.</span></span><br><span class="line"><span class="keyword">override</span> <span class="func"><span class="keyword">func</span> <span class="title">willMoveToParentViewController</span><span class="params">(parent: UIViewController?)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> parent = parent &#123;</span><br><span class="line">        <span class="built_in">assert</span>(parent.isKindOfClass(<span class="type">UINavigationController</span>), <span class="string">"Please read comments"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">self</span>.disposeBag = <span class="type">DisposeBag</span>()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 <code>UINavigationController</code> 中，这样的代码没有问题，但是当把这个 <code>view controller</code> 作为 <code>child view controller</code> 添加到其他界面的时候，会直接走到断言处。原因是在 <code>child view controller</code> 中，会先调用 <code>viewDidLoad</code> 再调用 <code>willMoveToParentViewController</code> ，好不容易绑定好的界面和事件流，结果直接 <code>self.disposeBag = DisposeBag()</code> 就给解绑了，自然出了问题。</p>
<h2 id="Demo2:_Wiki">Demo2: <a href="https://github.com/ReactiveX/RxSwift/tree/master/RxExample/RxExample/Examples/WikipediaImageSearch" target="_blank" rel="external">Wiki</a></h2><p>为什么在第一篇开头我就说：我又要挖坑了？因为我预见到。。。这个系列可能还没来得及写完就出其他事情了=。=</p>
<p>果然。</p>
<p>接下来专心前端和推荐算法了。有缘我们坑里再见。。。</p>
<h2 id="Next">Next</h2><p>各种异步各种回调的好处是整个应用行云流水让人感觉十分舒适，坏处是和 RAC 一样断点调试基本就是噩梦：</p>
<p><img src="http://ww2.sinaimg.cn/large/61d238c7gw1ewdy2ss0l9j21kw0xdtlw.jpg" alt=""></p>
<p>参考文献：</p>
<ul>
<li><a href="http://reactivex.io/documentation/operators/replay.html" target="_blank" rel="external">replay</a></li>
<li><a href="https://github.com/ReactiveX/RxSwift/blob/master/Documentation/GettingStarted.md" target="_blank" rel="external">Getting Started</a></li>
</ul>
</span>
      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/RxSwift/" rel="tag">#RxSwift</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2015/09/21/rxswift-getting-started-0/" rel="next" title="RxSwift 入坑手册 Part0 - 基础概念">
                <i class="fa fa-chevron-left"></i> RxSwift 入坑手册 Part0 - 基础概念
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2015/10/21/extension-in-yoapp/" rel="prev" title="Yoapp 小记 - 简单方便的扩展们">
                Yoapp 小记 - 简单方便的扩展们 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


        </div>

        


        
  <div class="comments" id="comments">
    
      <div class="ds-thread" data-thread-key="2015/09/23/rxswift-getting-started-1/"
           data-title="RxSwift 入坑手册 Part1 - 示例实战" data-url="http://blog.callmewhy.com/2015/09/23/rxswift-getting-started-1/">
      </div>
    
  </div>


      </div>

      
        
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" src="http://tp4.sinaimg.cn/1641167047/180/5691306924/1" alt="CallMeWhy" itemprop="image"/>
          <p class="site-author-name" itemprop="name">CallMeWhy</p>
        </div>
        <p class="site-description motion-element" itemprop="description">汪海的实验室</p>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">44</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          <div class="site-state-item site-state-categories">
            <a href="/categories">
              <span class="site-state-item-count">6</span>
              <span class="site-state-item-name">分类</span>
              </a>
          </div>

          <div class="site-state-item site-state-tags">
            <a href="/tags">
              <span class="site-state-item-count">39</span>
              <span class="site-state-item-name">标签</span>
              </a>
          </div>

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/callmewhy" target="_blank">
                  
                    <i class="fa fa-github"></i> GitHub
                  
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/small1030light" target="_blank">
                  
                    <i class="fa fa-weibo"></i> Weibo
                  
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://twitter.com/PleaseCallMeWhy" target="_blank">
                  
                    <i class="fa fa-twitter"></i> Twitter
                  
                </a>
              </span>
            
          
        </div>

        
        

        <div class="links-of-author motion-element">
          
            <p class="site-author-name">友情链接</p>
            
              <span class="links-of-author-item">
                <a href="http://ios.dog/" target="_blank">
                  <i class="fa fa-globe"></i> Boolean93
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://blog.luckymore.wang/" target="_blank">
                  <i class="fa fa-globe"></i> Luckymore
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://blog.zyliu.com/" target="_blank">
                  <i class="fa fa-globe"></i> Sheep
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://satanwoo.github.io/" target="_blank">
                  <i class="fa fa-globe"></i> Satanwoo
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://laker.me/blog/" target="_blank">
                  <i class="fa fa-globe"></i> Laker
                </a>
              </span>
            
          
        </div>

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc-indicator-top post-toc-indicator">
            <i class="fa fa-angle-double-up"></i>
          </div>
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Intro"><span class="nav-number">1.</span> <span class="nav-text">Intro</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Demo1:_GitHub_Signup"><span class="nav-number">2.</span> <span class="nav-text">Demo1: GitHub Signup</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#username"><span class="nav-number">2.1.</span> <span class="nav-text">username</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#rx_text"><span class="nav-number">2.1.1.</span> <span class="nav-text">rx_text</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#validate"><span class="nav-number">2.1.2.</span> <span class="nav-text">validate</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#switch"><span class="nav-number">2.1.3.</span> <span class="nav-text">switch</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#replay"><span class="nav-number">2.1.4.</span> <span class="nav-text">replay</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#usernameAvailable"><span class="nav-number">2.1.5.</span> <span class="nav-text">usernameAvailable</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#password"><span class="nav-number">2.2.</span> <span class="nav-text">password</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#bindValidationResultToUI"><span class="nav-number">2.3.</span> <span class="nav-text">bindValidationResultToUI</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#signupEnabled"><span class="nav-number">2.4.</span> <span class="nav-text">signupEnabled</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#signingProcess"><span class="nav-number">2.5.</span> <span class="nav-text">signingProcess</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#sample"><span class="nav-number">2.5.1.</span> <span class="nav-text">sample</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#signup"><span class="nav-number">2.5.2.</span> <span class="nav-text">signup</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#disposeBag"><span class="nav-number">2.5.3.</span> <span class="nav-text">disposeBag</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Demo2:_Wiki"><span class="nav-number">3.</span> <span class="nav-text">Demo2: Wiki</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Next"><span class="nav-number">4.</span> <span class="nav-text">Next</span></a></li></ol></div>
            
          </div>
          <div class="post-toc-indicator-bottom post-toc-indicator">
            <i class="fa fa-angle-double-down"></i>
          </div>
        </section>
      

    </div>
  </aside>


      
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2014 - 
  <span itemprop="copyrightYear">2015</span>
  <span class="with-love">
    <i class="icon-next-heart fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">CallMeWhy</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT
  </a>
</div>

<br/>



      </div>
    </footer>

    <div class="back-to-top"></div>
  </div>

  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  

  
    

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"CallMeWhy"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>
    

    
  

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/js/fancy-box.js?v=0.4.5.2"></script>


  <script type="text/javascript" src="/js/helpers.js?v=0.4.5.2"></script>
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>
<script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

<script type="text/javascript" src="/js/motion.js?v=0.4.5.2" id="motion.global"></script>


  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  
<script type="text/javascript" src="/js/bootstrap.scrollspy.js?v=0.4.5.2" id="bootstrap.scrollspy.custom"></script>


<script type="text/javascript" id="sidebar.toc.highlight">
  $(document).ready(function () {
    var tocSelector = '.post-toc';
    var $tocSelector = $(tocSelector);
    var activeCurrentSelector = '.active-current';

    $tocSelector
      .on('activate.bs.scrollspy', function () {
        var $currentActiveElement = $(tocSelector + ' .active').last();

        removeCurrentActiveClass();
        $currentActiveElement.addClass('active-current');

        $tocSelector[0].scrollTop = $currentActiveElement.position().top;
      })
      .on('clear.bs.scrollspy', function () {
        removeCurrentActiveClass();
      });

    function removeCurrentActiveClass () {
      $(tocSelector + ' ' + activeCurrentSelector)
        .removeClass(activeCurrentSelector.substring(1));
    }

    function processTOC () {
      getTOCMaxHeight();
      toggleTOCOverflowIndicators();
    }

    function getTOCMaxHeight () {
      var height = $('.sidebar').height() -
                   $tocSelector.position().top -
                   $('.post-toc-indicator-bottom').height();

      $tocSelector.css('height', height);

      return height;
    }

    function toggleTOCOverflowIndicators () {
      tocOverflowIndicator(
        '.post-toc-indicator-top',
        $tocSelector.scrollTop() > 0 ? 'show' : 'hide'
      );

      tocOverflowIndicator(
        '.post-toc-indicator-bottom',
        $tocSelector.scrollTop() >= $tocSelector.find('ol').height() - $tocSelector.height() ? 'hide' : 'show'
      )
    }

    $(document).on('sidebar.motion.complete', function () {
      processTOC();
    });

    $('body').scrollspy({ target: tocSelector });
    $(window).on('resize', function () {
      if ( $('.sidebar').hasClass('sidebar-active') ) {
        processTOC();
      }
    });

    onScroll($tocSelector);

    function onScroll (element) {
      element.on('mousewheel DOMMouseScroll', function (event) {
          var oe = event.originalEvent;
          var delta = oe.wheelDelta || -oe.detail;

          this.scrollTop += ( delta < 0 ? 1 : -1 ) * 30;
          event.preventDefault();

          toggleTOCOverflowIndicators();
      });
    }

    function tocOverflowIndicator (indicator, action) {
      var $indicator = $(indicator);
      var opacity = action === 'show' ? 1 : 0;
      $indicator.velocity ?
        $indicator.velocity('stop').velocity({
          opacity: opacity
        }, { duration: 100 }) :
        $indicator.stop().animate({
          opacity: opacity
        }, 100);
    }

  });
</script>

<script type="text/javascript" id="sidebar.nav">
  $(document).ready(function () {
    var html = $('html');
    var TAB_ANIMATE_DURATION = 200;
    var hasVelocity = $.isFunction(html.velocity);

    $('.sidebar-nav li').on('click', function () {
      var item = $(this);
      var activeTabClassName = 'sidebar-nav-active';
      var activePanelClassName = 'sidebar-panel-active';
      if (item.hasClass(activeTabClassName)) {
        return;
      }

      var currentTarget = $('.' + activePanelClassName);
      var target = $('.' + item.data('target'));

      hasVelocity ?
        currentTarget.velocity('transition.slideUpOut', TAB_ANIMATE_DURATION, function () {
          target
            .velocity('stop')
            .velocity('transition.slideDownIn', TAB_ANIMATE_DURATION)
            .addClass(activePanelClassName);
        }) :
        currentTarget.animate({ opacity: 0 }, TAB_ANIMATE_DURATION, function () {
          currentTarget.hide();
          target
            .stop()
            .css({'opacity': 0, 'display': 'block'})
            .animate({ opacity: 1 }, TAB_ANIMATE_DURATION, function () {
              currentTarget.removeClass(activePanelClassName);
              target.addClass(activePanelClassName);
            });
        });

      item.siblings().removeClass(activeTabClassName);
      item.addClass(activeTabClassName);
    });

    $('.post-toc a').on('click', function (e) {
      e.preventDefault();
      var targetSelector = escapeSelector(this.getAttribute('href'));
      var offset = $(targetSelector).offset().top;
      hasVelocity ?
        html.velocity('stop').velocity('scroll', {
          offset: offset  + 'px',
          mobileHA: false
        }) :
        $('html, body').stop().animate({
          scrollTop: offset
        }, 500);
    });

    // Expand sidebar on post detail page by default, when post has a toc.
    motionMiddleWares.sidebar = function () {
      var $tocContent = $('.post-toc-content');
      if (CONFIG.sidebar === 'post') {
        if ($tocContent.length > 0 && $tocContent.html().trim().length > 0) {
          displaySidebar();
        }
      }
    };
  });
</script>



  <script type="text/javascript" src="/js/bootstrap.js"></script>

  
  

  
  

</body>
</html>
