<!doctype html>
<html class="theme-next   use-motion ">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"/>




  
    <link href='//fonts.lug.ustc.edu.cn/css?family=Lato:300,400,700,400italic&subset=latin,latin-ext' rel='stylesheet' type='text/css'>
  



<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=0.4.5.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Timer," />





  <link rel="alternate" href="/atom.xml" title="Why's Blog" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=0.4.5.2" />






<meta name="description" content="Timer ！放开那个 self 让我来！">
<meta property="og:type" content="article">
<meta property="og:title" content="iOS 中的 NSTimer">
<meta property="og:url" content="http://blog.callmewhy.com/2015/07/06/weak-timer-in-ios/index.html">
<meta property="og:site_name" content="Why's Blog">
<meta property="og:description" content="Timer ！放开那个 self 让我来！">
<meta property="og:image" content="http://ww4.sinaimg.cn/large/61d238c7gw1ettf9re22uj20fu08owf3.jpg">
<meta property="og:updated_time" content="2015-07-21T06:20:32.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="iOS 中的 NSTimer">
<meta name="twitter:description" content="Timer ！放开那个 self 让我来！">



<script type="text/javascript" id="hexo.configuration">
  var CONFIG = {
    scheme: '',
    sidebar: 'post',
    motion: true
  };
</script>

  <title> iOS 中的 NSTimer | Why's Blog </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  <!--[if lte IE 8]>
  <div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;margin:0 auto;'>
    <a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode">
      <img src="http://7u2nvr.com1.z0.glb.clouddn.com/picouterie.jpg" border="0" height="42" width="820"
           alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today or use other browser ,like chrome firefox safari."
           style='margin-left:auto;margin-right:auto;display: block;'/>
    </a>
  </div>
<![endif]-->
  



  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?d4761ad5a08d996a2d7b90d5b1a79395";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <div class="container one-column page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Why's Blog</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">从明天起，做一个幸福的人。面朝汪海，春暖花开。</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu menu-left">
      
        
        
          <li class="menu-item menu-item-home">
            <a href="/" rel="section">
              
                <i class="menu-item-icon fa fa-home fa-fw"></i> <br />
              
              首页
            </a>
          </li>
        
      
        
        
      
        
        
      
        
        
          <li class="menu-item menu-item-archives">
            <a href="/archives" rel="section">
              
                <i class="menu-item-icon fa fa-archive fa-fw"></i> <br />
              
              归档
            </a>
          </li>
        
      
        
        
          <li class="menu-item menu-item-about">
            <a href="/about" rel="section">
              
                <i class="menu-item-icon fa fa-user fa-fw"></i> <br />
              
              关于
            </a>
          </li>
        
      

      
      
        <li class="menu-item menu-item-search">
          <a href="#" class="st-search-show-outputs">
            
              <i class="menu-item-icon fa fa-search icon-next-search"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  

<script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
    (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
    e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

  _st('install', 'J2QQHPVLVpZZmkmZhBSf','2.0.0');
</script>



    </div>
  
</nav>
 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div id="content" class="content">
          

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                iOS 中的 NSTimer
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2015-07-06T00:40:42+08:00" content="2015-07-06">
              2015-07-06
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/开发笔记/" itemprop="url" rel="index">
                    <span itemprop="name">开发笔记</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/07/06/weak-timer-in-ios/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/07/06/weak-timer-in-ios/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        <span itemprop="articleBody"><p>前阵子在整理公司项目的时候，发现老代码在使用 <code>NSTimer</code> 时出现了内存泄露。然后整理了一些 <code>NSTimer</code> 的相关内容。比较简单，各位见笑啦。</p>
<h2 id="NSTimer">NSTimer</h2><h3 id="fire">fire</h3><p>我们先用 <code>NSTimer</code> 来做个简单的计时器，每隔5秒钟在控制台输出 Fire 。比较想当然的做法是这样的：</p>
<pre><code><span class="class"><span class="keyword">@interface</span> <span class="title">DetailViewController</span> ()</span>
<span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">weak</span>) <span class="built_in">NSTimer</span> *timer;
<span class="keyword">@end</span>

<span class="class"><span class="keyword">@implementation</span> <span class="title">DetailViewController</span></span>
- (<span class="keyword">IBAction</span>)fireButtonPressed:(<span class="keyword">id</span>)sender {
    _timer = [<span class="built_in">NSTimer</span> scheduledTimerWithTimeInterval:<span class="number">3.0</span>f
                                              target:<span class="keyword">self</span>
                                            selector:<span class="keyword">@selector</span>(timerFire:)
                                            userInfo:<span class="literal">nil</span>
                                             repeats:<span class="literal">YES</span>];
    [_timer fire];
}

-(<span class="keyword">void</span>)timerFire:(<span class="keyword">id</span>)userinfo {
    <span class="built_in">NSLog</span>(<span class="string">@"Fire"</span>);
}
<span class="keyword">@end</span>
</code></pre><p>运行之后确实在控制台每隔3秒钟输出一次 Fire ，然而当我们从这个界面跳转到其他界面的时候却发现：控制台还在源源不断的输出着 Fire 。看来 <code>Timer</code> 并没有停止。</p>
<h3 id="invalidate">invalidate</h3><p>既然没有停止，那我们在 <code>DemoViewController</code> 的 <code>dealloc</code> 里加上 <code>invalidate</code> 的方法：</p>
<pre><code>-(<span class="keyword">void</span>)dealloc {
    [_timer invalidate];
    <span class="built_in">NSLog</span>(<span class="string">@"%@ dealloc"</span>, <span class="built_in">NSStringFromClass</span>([<span class="keyword">self</span> class]));
}
</code></pre><p>再次运行，还是没有停止。原因是 <code>Timer</code> 添加到 <code>Runloop</code> 的时候，会被 <code>Runloop</code> 强引用：</p>
<blockquote>
<p>Note in particular that run loops maintain strong references to their timers, so you don’t have to maintain your own strong reference to a timer after you have added it to a run loop. </p>
</blockquote>
<p>然后 <code>Timer</code> 又会有一个对 <code>Target</code> 的强引用（也就是 self ）：</p>
<blockquote>
<p>Target is the object to which to send the message specified by aSelector when the timer fires. The timer maintains a strong reference to target until it (the timer) is invalidated.</p>
</blockquote>
<p>也就是说 <code>NSTimer</code> 强引用了 <code>self</code> ，导致 <code>self</code> 一直不能被释放掉，所以也就走不到 <code>self</code> 的 <code>dealloc</code> 里。</p>
<p>既然如此，那我们可以再加个 <code>invalidate</code> 按钮：</p>
<pre><code><span class="tag">-</span> (IBAction)<span class="tag">invalidateButtonPressed</span>:(id)<span class="tag">sender</span> {
    <span class="attr_selector">[_timer invalidate]</span>;
}
</code></pre><p>嗯这样就可以了。（在 <a href="http://stackoverflow.com/questions/15170518/how-to-stop-invalidate-nstimer" target="_blank" rel="external">SOF</a> 上有人说该在 <code>invalidate</code> 之后执行 <code>_timer = nil</code> ，未能理解为什么，如果你知道原因可以告诉我：）</p>
<p>在 <code>invalidate</code> 方法的文档里还有这这样一段话：</p>
<blockquote>
<p>You must send this message from the thread on which the timer was installed. If you send this message from another thread, the input source associated with the timer may not be removed from its run loop, which could prevent the thread from exiting properly.</p>
</blockquote>
<p><code>NSTimer</code> 在哪个线程创建就要在哪个线程停止，否则会导致资源不能被正确的释放。看起来各种坑还不少。</p>
<h3 id="dealloc">dealloc</h3><p>那么问题来了：如果我就是想让这个 <code>NSTimer</code> 一直输出，直到 <code>DemoViewController</code> 销毁了才停止，我该如何让它停止呢？</p>
<ul>
<li>NSTimer 被 Runloop 强引用了，如果要释放就要调用 <code>invalidate</code> 方法。</li>
<li>但是我想在 <code>DemoViewController</code> 的 <code>dealloc</code> 里调用 <code>invalidate</code> 方法，但是 <code>self</code> 被 <code>NSTimer</code> 强引用了。</li>
<li>所以我还是要释放 <code>NSTimer</code> 先，然而不调用 <code>invalidate</code> 方法就不能释放它。</li>
<li>然而你不进入到 <code>dealloc</code> 方法里我又不能调用 <code>invalidate</code> 方法。</li>
<li>嗯…</li>
</ul>
<p><img src="http://ww4.sinaimg.cn/large/61d238c7gw1ettf9re22uj20fu08owf3.jpg" alt=""></p>
<h2 id="HWWeakTimer">HWWeakTimer</h2><h3 id="weakSelf">weakSelf</h3><p>问题的关键就在于 <code>self</code> 被 <code>NSTimer</code> 强引用了，如果我们能打破这个强引用问题自然而然就解决了。所以一个很简单的想法就是：<code>weakSelf</code>：</p>
<pre><code>__<span class="keyword">weak</span> <span class="keyword">typeof</span>(<span class="keyword">self</span>) weakSelf = <span class="keyword">self</span>;
_timer = [<span class="built_in">NSTimer</span> scheduledTimerWithTimeInterval:<span class="number">3.0</span>f
                                          target:weakSelf
                                        selector:<span class="keyword">@selector</span>(timerFire:)
                                        userInfo:<span class="literal">nil</span>
                                         repeats:<span class="literal">YES</span>];
</code></pre><p>然而这并没有什么卵用，这里的 <code>__weak</code> 和 <code>__strong</code> 唯一的区别就是：如果在这两行代码执行的期间 <code>self</code> 被释放了， <code>NSTimer</code> 的 <code>target</code> 会变成 <code>nil</code> 。</p>
<h3 id="target">target</h3><p>既然没办法通过 <code>__weak</code> 把 <code>self</code> 抽离出来，我们可以造个假的 <code>target</code> 给 <code>NSTimer</code> 。这个假的 <code>target</code> 类似于一个中间的代理人，它做的唯一的工作就是挺身而出接下了 <code>NSTimer</code> 的强引用。类声明如下：</p>
<pre><code><span class="variable">@interface</span> <span class="attribute">HWWeakTimerTarget </span>: NSObject
<span class="variable">@property</span> (nonatomic, weak) id target;
<span class="variable">@property</span> (nonatomic, assign) SEL selector;
<span class="variable">@property</span> (nonatomic, weak) NSTimer* timer;
<span class="variable">@end</span>

<span class="variable">@implementation</span> HWWeakTimerTarget
- (void) <span class="attribute">fire</span>:(NSTimer *)timer {
    <span class="tag">if</span>(self.target) {
        <span class="attr_selector">[self.target performSelector:self.selector withObject:timer.userInfo]</span>;
    } else {
        <span class="attr_selector">[self.timer invalidate]</span>;
    }
}
<span class="variable">@end</span>
</code></pre><p>然后我们再封装个假的 <code>scheduledTimerWithTimeInterval</code> 方法，但是在调用的时候已经偷梁换柱了：</p>
<pre><code>+ <span class="list">(<span class="keyword">NSTimer</span> <span class="variable">*) scheduledTimerWithTimeInterval:(NSTimeInterval)interval
                                      target:(id)aTarget
                                    selector:(SEL)aSelector
                                    userInfo:(id)userInfo
                                     repeats:(BOOL)repeats {
    HWWeakTimerTarget*</span> timerTarget = [[HWWeakTimerTarget alloc] init]<span class="comment">;</span>
    timerTarget.target = aTarget<span class="comment">;</span>
    timerTarget.selector = aSelector<span class="comment">;</span>
    timerTarget.timer = [NSTimer scheduledTimerWithTimeInterval<span class="keyword">:interval</span>
                                                         target<span class="keyword">:timerTarget</span>
                                                       selector:@selector<span class="list">(<span class="keyword">fire</span>:)</span>
                                                       userInfo<span class="keyword">:userInfo</span>
                                                        repeats<span class="keyword">:repeats</span>]<span class="comment">;</span>
    return timerTarget.timer<span class="comment">;</span>
}</span>
</code></pre><p>再次运行，问题解决。</p>
<h3 id="block">block</h3><p>如果能用 <code>block</code> 来调用 <code>NSTimer</code> 那岂不是更好了。我们可以这样来实现：</p>
<pre><code>+ (NSTimer *)scheduledTimerWithTimeInterval:(NSTimeInterval)interval
                                      <span class="built_in">block</span>:(HWTimerHandler)<span class="built_in">block</span>
                                   <span class="keyword">user</span>Info:(id)<span class="keyword">user</span>Info
                                    repeats:(BOOL)repeats {
    return [<span class="literal">self</span> scheduledTimerWithTimeInterval:interval
                                         target:<span class="literal">self</span>
                                       selector:@selector(_timerBlockInvoke:)
                                       <span class="keyword">user</span>Info:@[[<span class="built_in">block</span> copy], <span class="keyword">user</span>Info]
                                        repeats:repeats];
}

+ (void)_timerBlockInvoke:(NSArray*)<span class="keyword">user</span>Info {
    HWTimerHandler <span class="built_in">block</span> = <span class="keyword">user</span>Info[<span class="number">0</span>];
    id info = <span class="keyword">user</span>Info[<span class="number">1</span>];
    // or `!<span class="built_in">block</span> ?: <span class="built_in">block</span>();` @sunnyxx
    if (<span class="built_in">block</span>) {
        <span class="built_in">block</span>(info);
    }
}
</code></pre><p>这样我们就可以直接在 <code>block</code> 里写相关逻辑了：</p>
<pre><code>- (IBAction)<span class="string">fireButtonPressed:</span>(id)sender {
    _timer = [HWWeakTimer <span class="string">scheduledTimerWithTimeInterval:</span><span class="number">3.0</span>f <span class="string">block:</span>^(id userInfo) {
        NSLog(@<span class="string">"%@"</span>, userInfo);
    } <span class="string">userInfo:</span>@<span class="string">"Fire"</span> <span class="string">repeats:</span>YES];
    [_timer fire];
}
</code></pre><p>嗯就是这样。</p>
<h2 id="More">More</h2><p>把上面的的代码简单的封装到了 <a href="https://github.com/ChatGame/HWWeakTimer" target="_blank" rel="external"><code>HWWeakTimer</code></a> 中，欢迎试用。</p>
<h2 id="More_More">More More</h2><p>感谢 <a href="http://weibo.com/easyios" target="_blank" rel="external">@代码不会写</a> 和 @<a href="http://weibo.com/msching" target="_blank" rel="external">程寅zju</a> 的提醒，提供了另一个更为简洁的<a href="https://github.com/easyui/EZToolKit/blob/master/EZToolKit/EZCategory/NSTimer%2BEZ_Helper.m" target="_blank" rel="external">方案</a>：</p>
<pre><code><span class="comment">//</span>
<span class="comment">//  NSTimer+EZ_Helper.m</span>
<span class="comment">//  EZToolKit</span>
<span class="comment">//</span>
<span class="comment">//  Created by yangjun zhu on 15/5/20.</span>
<span class="comment">//  Copyright (c) 2015年 Cactus. All rights reserved.</span>
<span class="comment">//</span>

<span class="preprocessor">#import <span class="title">"NSTimer+EZ_Helper.h"</span></span>

<span class="class"><span class="keyword">@implementation</span> <span class="title">NSTimer</span> (<span class="title">EZ_Helper</span>)</span>
+ (<span class="built_in">NSTimer</span> *)ez_scheduledTimerWithTimeInterval:(<span class="built_in">NSTimeInterval</span>)inTimeInterval block:(<span class="keyword">void</span> (^)())inBlock repeats:(<span class="built_in">BOOL</span>)inRepeats
{
    <span class="keyword">void</span> (^block)() = [inBlock <span class="keyword">copy</span>];
    <span class="built_in">NSTimer</span> * timer = [<span class="keyword">self</span> scheduledTimerWithTimeInterval:inTimeInterval target:<span class="keyword">self</span> selector:<span class="keyword">@selector</span>(__executeTimerBlock:) userInfo:block repeats:inRepeats];
    <span class="keyword">return</span> timer;
}

+ (<span class="built_in">NSTimer</span> *)ez_timerWithTimeInterval:(<span class="built_in">NSTimeInterval</span>)inTimeInterval block:(<span class="keyword">void</span> (^)())inBlock repeats:(<span class="built_in">BOOL</span>)inRepeats
{
    <span class="keyword">void</span> (^block)() = [inBlock <span class="keyword">copy</span>];
    <span class="built_in">NSTimer</span> * timer = [<span class="keyword">self</span> timerWithTimeInterval:inTimeInterval target:<span class="keyword">self</span> selector:<span class="keyword">@selector</span>(__executeTimerBlock:) userInfo:block repeats:inRepeats];
    <span class="keyword">return</span> timer;
}

+ (<span class="keyword">void</span>)__executeTimerBlock:(<span class="built_in">NSTimer</span> *)inTimer;
{
    <span class="keyword">if</span>([inTimer userInfo])
    {
        <span class="keyword">void</span> (^block)() = (<span class="keyword">void</span> (^)())[inTimer userInfo];
        block();
    }
}
<span class="keyword">@end</span>
</code></pre><hr>
<p>参考文献：</p>
<ul>
<li><a href="https://developer.apple.com/library/mac/documentation/Cocoa/Reference/Foundation/Classes/NSTimer_Class/" target="_blank" rel="external">NStimer</a></li>
<li><a href="http://stackoverflow.com/questions/15170518/how-to-stop-invalidate-nstimer" target="_blank" rel="external">How to stop/invalidate NStimer</a></li>
<li><a href="http://stackoverflow.com/questions/16821736/weak-reference-to-nstimer-target-to-prevent-retain-cycle" target="_blank" rel="external">Weak Reference to NSTimer Target To Prevent Retain Cycle</a></li>
<li><a href="http://stackoverflow.com/questions/7017281/performselector-may-cause-a-leak-because-its-selector-is-unknown" target="_blank" rel="external">performSelector may cause a leak because its selector is unknown</a></li>
</ul>
</span>
      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Timer/" rel="tag">#Timer</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2015/06/29/4clojure-everyday/" rel="next" title="Clojure 每日练习">
                <i class="fa fa-chevron-left"></i> Clojure 每日练习
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2015/08/09/how-to-make-uther/" rel="prev" title="Uther 小记 - 一个简单地蠢萌机器人">
                Uther 小记 - 一个简单地蠢萌机器人 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


        </div>

        


        
  <div class="comments" id="comments">
    
      <div class="ds-thread" data-thread-key="2015/07/06/weak-timer-in-ios/"
           data-title="iOS 中的 NSTimer" data-url="http://blog.callmewhy.com/2015/07/06/weak-timer-in-ios/">
      </div>
    
  </div>


      </div>

      
        
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" src="http://tp4.sinaimg.cn/1641167047/180/5691306924/1" alt="CallMeWhy" itemprop="image"/>
          <p class="site-author-name" itemprop="name">CallMeWhy</p>
        </div>
        <p class="site-description motion-element" itemprop="description">汪海的实验室</p>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">44</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          <div class="site-state-item site-state-categories">
            <a href="/categories">
              <span class="site-state-item-count">6</span>
              <span class="site-state-item-name">分类</span>
              </a>
          </div>

          <div class="site-state-item site-state-tags">
            <a href="/tags">
              <span class="site-state-item-count">38</span>
              <span class="site-state-item-name">标签</span>
              </a>
          </div>

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/callmewhy" target="_blank">
                  
                    <i class="fa fa-github"></i> GitHub
                  
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/small1030light" target="_blank">
                  
                    <i class="fa fa-weibo"></i> Weibo
                  
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://twitter.com/PleaseCallMeWhy" target="_blank">
                  
                    <i class="fa fa-twitter"></i> Twitter
                  
                </a>
              </span>
            
          
        </div>

        
        

        <div class="links-of-author motion-element">
          
            <p class="site-author-name">友情链接</p>
            
              <span class="links-of-author-item">
                <a href="http://ios.dog/" target="_blank">
                  <i class="fa fa-globe"></i> Boolean93
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://blog.luckymore.wang/" target="_blank">
                  <i class="fa fa-globe"></i> Luckymore
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://blog.zyliu.com/" target="_blank">
                  <i class="fa fa-globe"></i> Sheep
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://satanwoo.github.io/" target="_blank">
                  <i class="fa fa-globe"></i> Satanwoo
                </a>
              </span>
            
          
        </div>

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc-indicator-top post-toc-indicator">
            <i class="fa fa-angle-double-up"></i>
          </div>
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#NSTimer"><span class="nav-number">1.</span> <span class="nav-text">NSTimer</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#fire"><span class="nav-number">1.1.</span> <span class="nav-text">fire</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#invalidate"><span class="nav-number">1.2.</span> <span class="nav-text">invalidate</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#dealloc"><span class="nav-number">1.3.</span> <span class="nav-text">dealloc</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#HWWeakTimer"><span class="nav-number">2.</span> <span class="nav-text">HWWeakTimer</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#weakSelf"><span class="nav-number">2.1.</span> <span class="nav-text">weakSelf</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#target"><span class="nav-number">2.2.</span> <span class="nav-text">target</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#block"><span class="nav-number">2.3.</span> <span class="nav-text">block</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#More"><span class="nav-number">3.</span> <span class="nav-text">More</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#More_More"><span class="nav-number">4.</span> <span class="nav-text">More More</span></a></li></ol></div>
            
          </div>
          <div class="post-toc-indicator-bottom post-toc-indicator">
            <i class="fa fa-angle-double-down"></i>
          </div>
        </section>
      

    </div>
  </aside>


      
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2014 - 
  <span itemprop="copyrightYear">2015</span>
  <span class="with-love">
    <i class="icon-next-heart fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">CallMeWhy</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT
  </a>
</div>

<br/>



      </div>
    </footer>

    <div class="back-to-top"></div>
  </div>

  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  

  
    

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"CallMeWhy"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>
    

    
  

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/js/fancy-box.js?v=0.4.5.2"></script>


  <script type="text/javascript" src="/js/helpers.js?v=0.4.5.2"></script>
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>
<script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

<script type="text/javascript" src="/js/motion.js?v=0.4.5.2" id="motion.global"></script>


  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  
<script type="text/javascript" src="/js/bootstrap.scrollspy.js?v=0.4.5.2" id="bootstrap.scrollspy.custom"></script>


<script type="text/javascript" id="sidebar.toc.highlight">
  $(document).ready(function () {
    var tocSelector = '.post-toc';
    var $tocSelector = $(tocSelector);
    var activeCurrentSelector = '.active-current';

    $tocSelector
      .on('activate.bs.scrollspy', function () {
        var $currentActiveElement = $(tocSelector + ' .active').last();

        removeCurrentActiveClass();
        $currentActiveElement.addClass('active-current');

        $tocSelector[0].scrollTop = $currentActiveElement.position().top;
      })
      .on('clear.bs.scrollspy', function () {
        removeCurrentActiveClass();
      });

    function removeCurrentActiveClass () {
      $(tocSelector + ' ' + activeCurrentSelector)
        .removeClass(activeCurrentSelector.substring(1));
    }

    function processTOC () {
      getTOCMaxHeight();
      toggleTOCOverflowIndicators();
    }

    function getTOCMaxHeight () {
      var height = $('.sidebar').height() -
                   $tocSelector.position().top -
                   $('.post-toc-indicator-bottom').height();

      $tocSelector.css('height', height);

      return height;
    }

    function toggleTOCOverflowIndicators () {
      tocOverflowIndicator(
        '.post-toc-indicator-top',
        $tocSelector.scrollTop() > 0 ? 'show' : 'hide'
      );

      tocOverflowIndicator(
        '.post-toc-indicator-bottom',
        $tocSelector.scrollTop() >= $tocSelector.find('ol').height() - $tocSelector.height() ? 'hide' : 'show'
      )
    }

    $(document).on('sidebar.motion.complete', function () {
      processTOC();
    });

    $('body').scrollspy({ target: tocSelector });
    $(window).on('resize', function () {
      if ( $('.sidebar').hasClass('sidebar-active') ) {
        processTOC();
      }
    });

    onScroll($tocSelector);

    function onScroll (element) {
      element.on('mousewheel DOMMouseScroll', function (event) {
          var oe = event.originalEvent;
          var delta = oe.wheelDelta || -oe.detail;

          this.scrollTop += ( delta < 0 ? 1 : -1 ) * 30;
          event.preventDefault();

          toggleTOCOverflowIndicators();
      });
    }

    function tocOverflowIndicator (indicator, action) {
      var $indicator = $(indicator);
      var opacity = action === 'show' ? 1 : 0;
      $indicator.velocity ?
        $indicator.velocity('stop').velocity({
          opacity: opacity
        }, { duration: 100 }) :
        $indicator.stop().animate({
          opacity: opacity
        }, 100);
    }

  });
</script>

<script type="text/javascript" id="sidebar.nav">
  $(document).ready(function () {
    var html = $('html');
    var TAB_ANIMATE_DURATION = 200;
    var hasVelocity = $.isFunction(html.velocity);

    $('.sidebar-nav li').on('click', function () {
      var item = $(this);
      var activeTabClassName = 'sidebar-nav-active';
      var activePanelClassName = 'sidebar-panel-active';
      if (item.hasClass(activeTabClassName)) {
        return;
      }

      var currentTarget = $('.' + activePanelClassName);
      var target = $('.' + item.data('target'));

      hasVelocity ?
        currentTarget.velocity('transition.slideUpOut', TAB_ANIMATE_DURATION, function () {
          target
            .velocity('stop')
            .velocity('transition.slideDownIn', TAB_ANIMATE_DURATION)
            .addClass(activePanelClassName);
        }) :
        currentTarget.animate({ opacity: 0 }, TAB_ANIMATE_DURATION, function () {
          currentTarget.hide();
          target
            .stop()
            .css({'opacity': 0, 'display': 'block'})
            .animate({ opacity: 1 }, TAB_ANIMATE_DURATION, function () {
              currentTarget.removeClass(activePanelClassName);
              target.addClass(activePanelClassName);
            });
        });

      item.siblings().removeClass(activeTabClassName);
      item.addClass(activeTabClassName);
    });

    $('.post-toc a').on('click', function (e) {
      e.preventDefault();
      var targetSelector = escapeSelector(this.getAttribute('href'));
      var offset = $(targetSelector).offset().top;
      hasVelocity ?
        html.velocity('stop').velocity('scroll', {
          offset: offset  + 'px',
          mobileHA: false
        }) :
        $('html, body').stop().animate({
          scrollTop: offset
        }, 500);
    });

    // Expand sidebar on post detail page by default, when post has a toc.
    motionMiddleWares.sidebar = function () {
      var $tocContent = $('.post-toc-content');
      if (CONFIG.sidebar === 'post') {
        if ($tocContent.length > 0 && $tocContent.html().trim().length > 0) {
          displaySidebar();
        }
      }
    };
  });
</script>



  <script type="text/javascript" src="/js/bootstrap.js"></script>

  
  

  
  

</body>
</html>
